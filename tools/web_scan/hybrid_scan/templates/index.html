<!DOCTYPE html>
<html>
<head>
    <title>URL Scan</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        #scanResults {
            max-height: 500px;
            overflow-y: auto;
        }
        .list-group-item-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .list-group-item-success {
            background-color: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">URL Scan Results</h1>
        <a href="{{ url_for('config') }}" class="btn btn-secondary mt-3">Config</a>
        <form action="{{ url_for('scan_single_url') }}" method="post" class="mt-3">
            <div class="form-group">
                <label for="url">URL:</label>
                <input type="url" class="form-control" id="url" name="url" required>
            </div>
            <button type="submit" class="btn btn-primary">Scan URL</button>
        </form>
        
        <form action="{{ url_for('scan_urls') }}" method="post" class="mt-3">
            <button type="submit" id="scanButton" class="btn btn-primary">Scan All URLs</button>
        </form>
        
        <h2 class="mt-4">Scan Results</h2>
        <div id="scanResults" class="list-group mt-2">
            {% for scan in scans %}
                {% set status_class = 'secondary' %}
                {% if scan.status == 'Safe' %}
                    {% set status_class = 'success' %}
                {% elif scan.status == 'Dangerous' %}
                    {% set status_class = 'danger' %}
                {% elif scan.status == 'In queue for scanning' %}
                    {% set status_class = 'warning' %}
                {% elif scan.status == 'Scanning' %}
                    {% set status_class = 'info' %}
                {% endif %}
                <div class="list-group-item list-group-item-{{ status_class }}">
                    <strong>{{ scan.url }}</strong> - {{ scan.status }}
                    <span class="badge badge-info">{{ scan.scan_type }}</span>
                    <span class="badge badge-secondary">{{ scan.timestamp }}</span>
                </div>
            {% endfor %}
        </div>

        
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function updateScanStatus() {
            console.log("Updating scan status...");
            $.getJSON("/scan_status", function(data) {
                console.log("Received scan status:", data);
                var resultsHtml = '';
                $.each(data, function(url, status) {
                    var statusClass = getStatusClass(status);
                    resultsHtml += '<div class="list-group-item list-group-item-' + statusClass + '">' +
                                '<strong>' + url + ':</strong> ' + status + '</div>';
                });
                $('#scanResults').html(resultsHtml);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching scan status:", textStatus, errorThrown);
            });
        }

        function getStatusClass(status) {
            if (status === 'Safe') return 'success';
            else if (status === 'Dangerous') return 'danger';
            else if (status === 'Scanning') return 'info';
            else if (status === 'In queue for scanning') return 'warning';
            else return 'secondary';
        }

        $(document).ready(function() {
            $('#scanButton').click(function(event) {
                event.preventDefault();
                console.log("Scan button clicked");
                updateScanStatus();
                var intervalId = setInterval(updateScanStatus, 5000);
                setTimeout(function() {
                    clearInterval(intervalId);
                    console.log("Stopped updating scan status");
                }, 300000);
                $(this).closest('form').submit();
            });
        });
    </script>
</body>
</html>
